<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPIC CASE BATTLE v2</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #0b0b0e;
            --bg-secondary: #15151a;
            --bg-panel: #1e1e24;
            --primary: #ffaa00;
            --primary-glow: rgba(255, 170, 0, 0.4);
            --accent: #6c5ce7;
            --success: #00b894;
            --danger: #d63031;
            
            --text-main: #ffffff;
            --text-sec: #a4b0be;
            
            /* Rarity Colors - Bright Neon */
            --r-1: #b2bec3; /* Common */
            --r-2: #0984e3; /* Uncommon */
            --r-3: #6c5ce7; /* Rare */
            --r-4: #fd79a8; /* Mythical */
            --r-5: #e84393; /* Legendary */
            --r-6: #ffeaa7; /* Immortal (Gold) */
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            background: radial-gradient(circle at top center, #1a1a2e 0%, var(--bg-main) 80%);
            color: var(--text-main); font-family: 'Montserrat', sans-serif; padding-bottom: 50px; min-height: 100vh;
        }
        
        /* --- HEADER & NAV --- */
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 40px; background: rgba(20, 20, 25, 0.8); backdrop-filter: blur(10px);
            border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 50;
        }
        .logo { font-size: 28px; font-weight: 800; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 0 15px var(--primary-glow); }
        .balance-box { 
            background: linear-gradient(90deg, #111, #222); padding: 10px 25px; border-radius: 30px; 
            color: var(--success); font-weight: 800; font-size: 18px; border: 2px solid #333;
            box-shadow: 0 0 10px rgba(0,184,148,0.2);
        }
        
        nav { display: flex; justify-content: center; gap: 15px; margin: 30px 0; flex-wrap: wrap; }
        .nav-btn {
            background: var(--bg-secondary); border: 2px solid transparent; color: var(--text-sec);
            padding: 12px 30px; cursor: pointer; font-size: 14px; font-weight: 700; border-radius: 30px;
            transition: 0.3s; text-transform: uppercase;
        }
        .nav-btn:hover, .nav-btn.active { background: var(--accent); color: white; border-color: #8e7cff; box-shadow: 0 0 20px rgba(108, 92, 231, 0.4); }

        /* --- LAYOUT & CARDS --- */
        .section { display: none; padding: 20px 40px; max-width: 1400px; margin: 0 auto; animation: fadeIn 0.5s ease; }
        .section.active { display: block; }
        h2 { text-transform: uppercase; letter-spacing: 1px; margin-bottom: 25px; font-weight: 800; } @keyframes fadeIn { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform: translateY(0); } }

        /* More compact grid for inventory */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        /* Wider grid for cases */
        #cases-list, #battle-cases-list { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 25px; }

        .card {
            background: linear-gradient(145deg, var(--bg-panel), #23232a); border-radius: 12px; padding: 15px;
            text-align: center; cursor: pointer; transition: all 0.3s ease;
            border: 1px solid #333; position: relative; overflow: hidden;
        }
        .card:hover { transform: translateY(-7px); border-color: var(--primary); box-shadow: 0 10px 20px -10px var(--primary-glow); }
        .card img { width: 100%; height: 100px; object-fit: contain; margin-bottom: 15px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.5)); transition: 0.3s; }
        .card:hover img { transform: scale(1.05); }
        
        .item-price { color: var(--success); font-weight: 700; font-size: 15px; margin-top: 8px; }
        .item-name { font-weight: 600; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-sec); }
        
        /* Rarity Borders & Glows */
        .rarity-1 { border-bottom: 4px solid var(--r-1); }
        .rarity-2 { border-bottom: 4px solid var(--r-2); }
        .rarity-3 { border-bottom: 4px solid var(--r-3); }
        .rarity-4 { border-bottom: 4px solid var(--r-4); }
        .rarity-5 { border-bottom: 4px solid var(--r-5); box-shadow: inset 0 -15px 30px -15px rgba(232, 67, 147, 0.3); }
        .rarity-6 { border-bottom: 4px solid var(--r-6); box-shadow: inset 0 -15px 30px -15px rgba(255, 234, 167, 0.4); }

        /* --- NEW UPGRADE SYSTEM (Arrow Style) --- */
        .upgrade-flex { display: flex; align-items: center; justify-content: center; gap: 30px; margin-top: 40px; }
        .upg-card { width: 200px; height: 280px; background: var(--bg-secondary); border: 2px dashed #444; border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .upg-card.target { border: 2px solid var(--accent); background: linear-gradient(145deg, #1a1a2e, #252535); }
        
        .upg-middle { flex: 1; max-width: 500px; text-align: center; }
        
        .upgrade-bar-container {
            height: 40px; background: #111; border-radius: 20px; position: relative;
            overflow: hidden; border: 2px solid #333; margin: 30px 0;
            box-shadow: inset 0 5px 10px rgba(0,0,0,0.5);
        }
        /* The green success zone */
        .upgrade-bar-fill {
            position: absolute; left: 0; top: 0; height: 100%; width: 50%; /* Dynamic */
            background: linear-gradient(90deg, var(--success), #00b894);
            box-shadow: 0 0 20px var(--success); z-index: 1; transition: width 0.3s;
        }
        /* The moving marker */
        .upgrade-marker {
            position: absolute; left: 0%; top: -5px; width: 4px; height: 50px;
            background: #fff; z-index: 10; box-shadow: 0 0 15px #fff, 0 0 30px var(--primary);
            transition: left 4s cubic-bezier(0.1, 0.8, 0.1, 1);
        }
        .upgrade-marker::after { content: '‚ñº'; position: absolute; top: -18px; left: -6px; color: white; font-size: 14px; }
        
        .upg-controls input { background: #111; border: 2px solid #333; color: var(--primary); padding: 10px; width: 90px; text-align: center; font-size: 20px; font-weight: 800; border-radius: 10px; margin: 0 10px; }
        .btn-action { background: linear-gradient(45deg, var(--primary), #ff8e00); color: #000; padding: 12px 40px; border: none; font-weight: 800; cursor: pointer; border-radius: 30px; font-size: 18px; text-transform: uppercase; transition: 0.3s; box-shadow: 0 5px 15px rgba(255, 170, 0, 0.3); }
        .btn-action:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(255, 170, 0, 0.5); }
        
        /* --- INVENTORY BUTTONS --- */
        .action-btns { margin-top: 10px; display: flex; gap: 5px; opacity: 0.6; transition: 0.3s; }
        .card:hover .action-btns { opacity: 1; }
        .btn-small { flex: 1; border: none; padding: 6px; cursor: pointer; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .btn-sell { background: rgba(214, 48, 49, 0.2); color: var(--danger); }
        .btn-sell:hover { background: var(--danger); color: white; }
        .btn-upg { background: rgba(108, 92, 231, 0.2); color: var(--accent); }
        .btn-upg:hover { background: var(--accent); color: white; }

        /* --- ROULETTE & BATTLE (Styles adapted to new theme) --- */
        #roulette-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 1000; display: none;
            flex-direction: column; justify-content: center; align-items: center;
        }
        .roulette-window {
            width: 800px; height: 150px; background: #0a0a0c; border: 3px solid var(--primary);
            border-radius: 15px; position: relative; overflow: hidden; margin-bottom: 30px;
            box-shadow: 0 0 50px rgba(255, 170, 0, 0.2);
        }
        .roulette-strip { display: flex; height: 100%; align-items: center; }
        .roulette-card {
            min-width: 130px; height: 130px; margin: 0 2px; background: #15151a;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .roulette-card img { width: 90px; height: 90px; object-fit: contain; }
        .pointer {
            position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            width: 4px; height: 100%; background: #fff; z-index: 10;
            box-shadow: 0 0 15px #fff, 0 0 30px var(--primary);
        }
        .battle-arena { display: flex; justify-content: space-between; gap: 30px; margin-top: 40px; }
        .battle-side { width: 48%; background: var(--bg-secondary); padding: 25px; border-radius: 20px; text-align: center; border: 1px solid #333; }

        /* Toast */
        #toast { visibility: hidden; min-width: 300px; background: linear-gradient(90deg, #333, #222); color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 2000; left: 50%; bottom: 30px; transform: translateX(-50%); border-left: 6px solid var(--primary); font-weight: 600; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

<header>
    <div class="logo">‚ö° EPIC.DROP</div>
    <div style="display: flex; gap: 20px; align-items: center;">
        <button onclick="addBalance()" style="background:#222; border:1px solid #444; color:#888; cursor:pointer; padding: 5px 15px; border-radius: 20px; font-size: 12px;">+ DEBUG $$$</button>
        <div class="balance-box">$<span id="balance">1000.00</span></div>
    </div>
</header>

<nav>
    <button class="nav-btn active" onclick="showPage('cases')">üéÅ –ú–∞–≥–∞–∑–∏–Ω –ö–µ–π—Å–æ–≤</button>
    <button class="nav-btn" onclick="showPage('battle')">‚öî Case Battle 1v1</button>
    <button class="nav-btn" onclick="showPage('upgrade')">‚¨Ü –ê–ø–≥—Ä–µ–π–¥</button>
    <button class="nav-btn" onclick="showPage('inventory')">üéí –ú–æ–π –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
</nav>

<div id="cases" class="section active">
    <h2 style="text-align: center;">üî• –≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –ö–µ–π—Å—ã üî•</h2>
    <div class="grid-container" id="cases-list"></div>
</div>

<div id="battle" class="section">
    <div style="text-align: center; margin-bottom: 30px;">
        <h2 style="color: var(--danger);">‚öîÔ∏è –ë–∏—Ç–≤–∞ –ö–µ–π—Å–æ–≤ ‚öîÔ∏è</h2>
        <p style="color: var(--text-sec)">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å –∑–∞–±–∏—Ä–∞–µ—Ç –¥—Ä–æ–ø –æ–±–æ–∏—Ö –∏–≥—Ä–æ–∫–æ–≤!</p>
    </div>
    <div class="grid-container" id="battle-cases-list"></div>
    
    <div id="battle-arena" style="display:none;">
        <div class="battle-arena">
            <div class="battle-side" id="user-side" style="border-color: var(--success)">
                <h3 style="color: var(--success)">–¢–´</h3>
                <div class="roulette-window" style="width: 100%; height: 120px; border-color: #333;">
                    <div class="pointer"></div>
                    <div class="roulette-strip" id="user-strip"></div>
                </div>
                <div class="item-price" id="user-score" style="font-size: 24px;">$0.00</div>
            </div>
            <div class="battle-side" id="bot-side" style="border-color: var(--danger)">
                <h3 style="color: var(--danger)">–ë–û–¢ GABEN</h3>
                <div class="roulette-window" style="width: 100%; height: 120px; border-color: #333;">
                    <div class="pointer"></div>
                    <div class="roulette-strip" id="bot-strip"></div>
                </div>
                <div class="item-price" id="bot-score" style="font-size: 24px; color: var(--danger);">$0.00</div>
            </div>
        </div>
        <div style="text-align: center; margin-top: 40px;">
            <h1 id="battle-result-text" style="font-size: 40px; text-transform: uppercase; letter-spacing: 2px;">ROLLING...</h1>
            <button class="btn-action" id="battle-finish-btn" style="display:none; background: #333; color: white; margin-top: 20px;" onclick="resetBattle()">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–µ–π—Å–∞–º</button>
        </div>
    </div>
</div>

<div id="upgrade" class="section">
    <h2 style="text-align: center;">‚¨Ü –ê–ø–≥—Ä–µ–π–¥ –ü—Ä–µ–¥–º–µ—Ç–æ–≤</h2>
    <p style="text-align: center; color: var(--text-sec); margin-bottom: 30px;">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —É–ª—É—á—à–µ–Ω–∏–µ.</p>
    
    <div class="upgrade-flex">
        <div class="upg-card" id="upgrade-slot">
            <div style="color: #555; font-size: 50px;">üì¶</div>
            <div style="color: #555; margin-top: 10px;">–ü—Ä–µ–¥–º–µ—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
        </div>
        
        <div class="upg-middle">
            <div class="upgrade-bar-container">
                <div class="upgrade-bar-fill" id="upg-bar-fill" style="width: 45%;"></div>
                <div class="upgrade-marker" id="upg-marker" style="left: 0%;"></div>
            </div>
            
            <div class="upg-controls">
                <div style="font-size: 24px; font-weight: 800; color: var(--primary); margin-bottom: 15px;">
                    –®–ê–ù–°: <span id="upgrade-chance">45.00%</span>
                </div>
                <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 25px;">
                    <span style="font-weight: 700; color: var(--text-sec)">–ú–ù–û–ñ–ò–¢–ï–õ–¨: X</span>
                    <input type="number" id="multiplier" value="2" min="1.1" max="20" step="0.1" onchange="calcUpgradeChance()">
                </div>
                <button class="btn-action" id="btn-run-upg" onclick="runUpgrade()" disabled style="opacity: 0.5; cursor: not-allowed;">–ü–û–ü–†–û–ë–û–í–ê–¢–¨</button>
            </div>
        </div>
        
        <div class="upg-card target" id="upgrade-target">
             <div style="font-size: 50px;">‚ùì</div>
             <div style="margin-top: 10px;">–¶–µ–ª—å</div>
             <div id="target-price" style="color: var(--success); font-size: 20px; font-weight: 800;">$-.--</div>
        </div>
    </div>
</div>

<div id="inventory" class="section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2>üéí –í–∞—à–∏ –ü—Ä–µ–¥–º–µ—Ç—ã <span id="inv-count" style="color: var(--text-sec); font-size: 16px;">(0)</span></h2>
        <button class="btn-action" style="font-size: 14px; padding: 10px 25px; background: var(--danger);" onclick="sellAll()">–ü–†–û–î–ê–¢–¨ –í–°–Å</button>
    </div>
    <div class="grid-container" id="inventory-list"></div>
</div>

<div id="roulette-modal">
    <div class="roulette-window">
        <div class="pointer"></div>
        <div class="roulette-strip" id="roulette-strip"></div>
    </div>
    <div class="win-display" id="win-display" style="text-align: center; display: none; animation: fadeIn 0.5s;">
        <h2 style="color: var(--primary); font-size: 40px; margin-bottom: 20px;">–ü–û–ó–î–†–ê–í–õ–Ø–ï–ú! –í–´ –í–´–ë–ò–õ–ò:</h2>
        <div id="won-item-card" style="display: inline-block; transform: scale(1.2);"></div>
        <br><br>
        <button class="btn-action" onclick="closeRoulette()">–ó–ê–ë–†–ê–¢–¨ –í –ò–ù–í–ï–ù–¢–ê–†–¨</button>
    </div>
</div>

<div id="toast">Notification</div>

<script>
    // --- 1. CONFIG & ASSETS ---
    // Define colors for JS use
    const R_COLORS = {
        1: '#b2bec3', 2: '#0984e3', 3: '#6c5ce7', 4: '#fd79a8', 5: '#e84393', 6: '#ffeaa7'
    };
    const RARITY = {
        1: { name: 'Consumer', color: R_COLORS[1], chance: 50 },
        2: { name: 'Industrial', color: R_COLORS[2], chance: 28 },
        3: { name: 'Mil-Spec', color: R_COLORS[3], chance: 12 },
        4: { name: 'Restricted', color: R_COLORS[4], chance: 6 },
        5: { name: 'Classified', color: R_COLORS[5], chance: 3 },
        6: { name: 'Covert', color: R_COLORS[6], chance: 1 }
    };

    // Base names for standard items
    const BASE_NAMES = [
        ["P250 | Sand Dune", "Nova | Polar Mesh", "MP7 | Army Recon"], 
        ["MAG-7 | Silver", "Glock-18 | Death Rattle", "SSG 08 | Blue Spruce"],
        ["P90 | Elite Build", "AWP | Worm God", "M4A1-S | Flashback"],
        ["AK-47 | Slate", "USP-S | Cyrex", "Desert Eagle | Mecha Industries"],
        [], [], [] // Tiers 5 & 6 use specific images
    ];
    // Standard Emojis for tiers 1-4
    const EMOJIS = ["üî´", "üå™Ô∏è", "üå≤", "üíÄ"];
    
    // USER PROVIDED IMAGES (MUST BE IN SAME FOLDER)
    // Top Tier Item Images (q.PNG - z.PNG)
    const RARE_IMGS = [
        'q.PNG','w.PNG','e.PNG','r.PNG','t.PNG','y.PNG','u.PNG','i.PNG','o.PNG','p.PNG',
        'a.PNG','s.PNG','d.PNG','f.PNG','g.PNG','h.PNG','j.PNG','k.PNG','l.PNG','z.PNG'
    ];

    // Case Images (1.PNG - 11.PNG)
    const CASE_IMGS = [
        '1.PNG','2.PNG','3.PNG','4.PNG','5.PNG','6.PNG',
        '7.PNG','8.PNG','9.PNG','10.PNG','11.PNG'
    ];

    let ALL_ITEMS = [];
    let idCounter = 0;

    // Generate Items Database
    function generateItemsDB() {
        for(let r=1; r<=6; r++) {
            if(r <= 4) {
                // Standard emoji items
                BASE_NAMES[r-1].forEach(name => createItemEntry(r, name, EMOJIS[r-1], false));
            } else {
                // Rare PNG items (split randomly between tier 5 and 6)
                // We'll take 10 for Tier 5, and the rest for Tier 6
                let startIndex = (r===5) ? 0 : 10;
                let endIndex = (r===5) ? 10 : RARE_IMGS.length;
                
                for(let i=startIndex; i<endIndex; i++) {
                     // Using the filename base as the name for simplicity
                    let name = RARE_IMGS[i].split('.')[0].toUpperCase() + " | Rare Look";
                    createItemEntry(r, name, RARE_IMGS[i], true);
                }
            }
        }
    }

    function createItemEntry(r, name, imgSource, isPng) {
        let basePrice = Math.pow(5, r); // Steeper price curve
        let variance = Math.random() * basePrice * (r*0.2);
        let price = (basePrice + variance).toFixed(2);
        
        ALL_ITEMS.push({
            id: idCounter++,
            name: name,
            rarity: r,
            price: parseFloat(price),
            // Store HTML representation of the image/emoji
            imgHtml: isPng ? `<img src="${imgSource}" alt="${name}" onerror="this.onerror=null;this.src='https://via.placeholder.com/100?text=${imgSource}';">` 
                           : `<div style="font-size:50px;">${imgSource}</div>`
        });
    }

    // Define 11 Cases with new images
    const CASES = [
        { id: 0, name: "Bronze Case", price: 5, minR: 1, maxR: 2 },
        { id: 1, name: "Silver Case", price: 15, minR: 1, maxR: 3 },
        { id: 2, name: "Gold Case", price: 45, minR: 2, maxR: 3 },
        { id: 3, name: "Platinum Case", price: 90, minR: 2, maxR: 4 },
        { id: 4, name: "Diamond Case", price: 150, minR: 3, maxR: 4 },
        { id: 5, name: "Master Case", price: 250, minR: 3, maxR: 5 },
        { id: 6, name: "Challenger Case", price: 400, minR: 4, maxR: 5 },
        { id: 7, name: "Legendary Case", price: 750, minR: 4, maxR: 6 },
        { id: 8, name: "Immortal Case", price: 1500, minR: 5, maxR: 6 },
        { id: 9, name: "God Tier Case", price: 3000, minR: 5, maxR: 6 },
        { id: 10, name: "THE END GAME", price: 9999, minR: 6, maxR: 6 } // Only max rarity
    ];

    // --- 2. STATE & INIT ---
    let user = { balance: 2000.00, inventory: [] };
    let selectedUpgradeItem = null;

    function init() {
        generateItemsDB();
        loadData();
        updateBalanceUI();
        renderCases();
        renderInventory();
    }

    // --- 3. HELPER FUNCTIONS ---
    function showToast(msg, type='normal') {
        let x = document.getElementById("toast");
        x.innerText = msg;
        x.style.borderLeftColor = type === 'error' ? 'var(--danger)' : type === 'success' ? 'var(--success)' : 'var(--primary)';
        x.className = "show";
        setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000);
    }

    function updateBalanceUI() {
        document.getElementById('balance').innerText = user.balance.toFixed(2);
        saveData();
    }

    function addBalance() { user.balance += 1000; updateBalanceUI(); showToast("ADMIN: +$1000 Added", 'success'); }

    function showPage(pageId) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
        if(pageId === 'inventory') renderInventory();
        if(pageId === 'battle') renderBattleCases();
    }

    function getRandomItem(caseId) {
        const c = CASES[caseId];
        let pool = ALL_ITEMS.filter(i => i.rarity >= c.minR && i.rarity <= c.maxR);
        let totalWeight = 0;
        pool.forEach(i => {
            i.weight = RARITY[i.rarity].chance;
            totalWeight += i.weight;
        });
        let r = Math.random() * totalWeight;
        for(let item of pool) {
            if(r < item.weight) return item;
            r -= item.weight;
        }
        return pool[0];
    }

    // --- 4. ROULETTE OPENING ---
    function openCase(caseId) {
        const c = CASES[caseId];
        if(user.balance < c.price) { showToast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!", 'error'); return; }
        user.balance -= c.price; updateBalanceUI();

        const modal = document.getElementById('roulette-modal');
        const strip = document.getElementById('roulette-strip');
        const winDiv = document.getElementById('win-display');
        
        modal.style.display = 'flex';
        strip.style.transition = 'none';
        strip.style.transform = 'translateX(0px)';
        winDiv.style.display = 'none';
        strip.innerHTML = '';

        let items = [];
        for(let i=0; i<60; i++) items.push(getRandomItem(caseId));
        const winnerPos = 50;
        const winner = items[winnerPos];

        items.forEach(item => {
            let el = document.createElement('div');
            el.className = `roulette-card rarity-${item.rarity}`;
            el.innerHTML = item.imgHtml;
            strip.appendChild(el);
        });

        setTimeout(() => {
            // Card width 130 + margin 4 = 134px. Center offset approx 400px.
            let offset = winnerPos * 134 - 335 + (Math.random()*120); 
            strip.style.transition = 'transform 5s cubic-bezier(0.1, 0.85, 0.1, 1)';
            strip.style.transform = `translateX(-${offset}px)`;
        }, 100);

        setTimeout(() => {
            winDiv.style.display = 'block';
            document.getElementById('won-item-card').innerHTML = `
                <div class="card rarity-${winner.rarity}" style="width: 200px; pointer-events:none;">
                    ${winner.imgHtml}
                    <div class="item-name" style="font-size:16px;">${winner.name}</div>
                    <div class="item-price">$${winner.price.toFixed(2)}</div>
                </div>`;
            winner.uniqueId = Date.now();
            user.inventory.unshift(winner); // Add to start of inventory
            saveData(); renderInventory();
        }, 5100);
    }
    function closeRoulette() { document.getElementById('roulette-modal').style.display = 'none'; }

    // --- 5. BATTLE SYSTEM ---
    let battleActive = false;
    function startBattle(caseId) {
        if(battleActive) return;
        const c = CASES[caseId];
        if(user.balance < c.price) { showToast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!", 'error'); return; }
        user.balance -= c.price; updateBalanceUI();
        
        battleActive = true;
        document.getElementById('battle-cases-list').style.display = 'none';
        document.getElementById('battle-arena').style.display = 'block';
        document.getElementById('battle-finish-btn').style.display = 'none';
        document.getElementById('battle-result-text').innerHTML = "ROLLING...";
        document.getElementById('battle-result-text').style.color = "#fff";

        const userWin = getRandomItem(caseId);
        const botWin = getRandomItem(caseId);
        runBattleStrip('user-strip', userWin);
        runBattleStrip('bot-strip', botWin);

        setTimeout(() => {
            document.getElementById('user-score').innerText = `$${userWin.price.toFixed(2)}`;
            document.getElementById('bot-score').innerText = `$${botWin.price.toFixed(2)}`;
            let totalPot = userWin.price + botWin.price;
            
            if(userWin.price >= botWin.price) {
                document.getElementById('battle-result-text').innerHTML = `üéâ –ü–û–ë–ï–î–ê! <br>–í–´ –ó–ê–ë–†–ê–õ–ò $${totalPot.toFixed(2)}`;
                document.getElementById('battle-result-text').style.color = "var(--success)";
                userWin.uniqueId = Date.now(); botWin.uniqueId = Date.now() + 1;
                user.inventory.unshift(botWin); user.inventory.unshift(userWin);
                showToast(`–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ –±–∏—Ç–≤—É! +$${totalPot.toFixed(2)} –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å`, 'success');
            } else {
                document.getElementById('battle-result-text').innerText = "–ë–û–¢ –í–´–ò–ì–†–ê–õ :(";
                document.getElementById('battle-result-text').style.color = "var(--danger)";
                showToast("–ë–æ—Ç –∑–∞–±—Ä–∞–ª –ø—Ä–µ–¥–º–µ—Ç—ã", 'error');
            }
            document.getElementById('battle-finish-btn').style.display = 'inline-block';
            saveData(); renderInventory();
        }, 4100);
    }

    function runBattleStrip(elementId, winnerItem) {
        const strip = document.getElementById(elementId);
        strip.innerHTML = ''; strip.style.transition = 'none'; strip.style.transform = 'translateX(0)';
        let items = [];
        for(let i=0; i<40; i++) items.push(ALL_ITEMS[Math.floor(Math.random()*ALL_ITEMS.length)]);
        const winPos = 35;
        items[winPos] = winnerItem;
        items.forEach(item => {
            let el = document.createElement('div'); el.className = `roulette-card rarity-${item.rarity}`;
            el.innerHTML = item.imgHtml; el.style.borderBottom = `3px solid ${R_COLORS[item.rarity]}`;
            strip.appendChild(el);
        });
        setTimeout(() => {
            let offset = winPos * 134 - 180 + (Math.random()*80);
            strip.style.transition = 'transform 4s cubic-bezier(0.1, 0.85, 0.1, 1)';
            strip.style.transform = `translateX(-${offset}px)`;
        }, 50);
    }
    function resetBattle() {
        battleActive = false; document.getElementById('battle-arena').style.display = 'none';
        document.getElementById('battle-cases-list').style.display = 'grid';
        document.getElementById('user-score').innerText = "$0.00"; document.getElementById('bot-score').innerText = "$0.00";
    }

    // --- 6. NEW UPGRADE SYSTEM (Arrow) ---
    function prepUpgrade(uId) {
        let item = user.inventory.find(i => i.uniqueId === uId);
        if(!item) return;
        selectedUpgradeItem = item;
        showPage('upgrade');
        
        // Reset UI
        document.getElementById('upg-marker').style.transition = 'none';
        document.getElementById('upg-marker').style.left = '0%';
        
        document.getElementById('upgrade-slot').innerHTML = `
             ${item.imgHtml}
             <div class="item-name" style="color:${R_COLORS[item.rarity]}; margin-top:10px;">${item.name}</div>
             <div class="item-price">$${item.price.toFixed(2)}</div>
        `;
        document.getElementById('upgrade-slot').classList.remove('target');
        document.getElementById('upgrade-slot').style.border = `2px solid ${R_COLORS[item.rarity]}`;
        
        document.getElementById('btn-run-upg').disabled = false;
        document.getElementById('btn-run-upg').style.opacity = '1';
        document.getElementById('btn-run-upg').style.cursor = 'pointer';
        calcUpgradeChance();
    }

    function calcUpgradeChance() {
        let mult = parseFloat(document.getElementById('multiplier').value);
        if(!selectedUpgradeItem || isNaN(mult)) return;
        
        // House edge 8%
        let chance = (1 / mult) * 92; 
        if (chance > 90) chance = 90; if (chance < 5) chance = 5; // Caps
        
        document.getElementById('upgrade-chance').innerText = chance.toFixed(2) + '%';
        // Update green bar width
        document.getElementById('upg-bar-fill').style.width = chance + '%';
        
        let targetPrice = selectedUpgradeItem.price * mult;
        document.getElementById('target-price').innerText = `$${targetPrice.toFixed(2)}`;
        
        // Find a hypothetical item to show as target visually
        let targetRarity = Math.min(6, selectedUpgradeItem.rarity + (mult > 5 ? 2 : 1));
        let potentialTargets = ALL_ITEMS.filter(i => i.rarity === targetRarity);
        let demoTarget = potentialTargets[Math.floor(Math.random()*potentialTargets.length)];
        
        if(demoTarget) {
             document.getElementById('upgrade-target').innerHTML = `
                 ${demoTarget.imgHtml}
                 <div class="item-name" style="margin-top:10px;">–í–æ–∑–º–æ–∂–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
                 <div class="item-price">$${targetPrice.toFixed(2)}</div>
            `;
        }
    }

    function runUpgrade() {
        if(!selectedUpgradeItem) return;
        const btn = document.getElementById('btn-run-upg');
        btn.disabled = true; btn.style.opacity = '0.5';
        
        let mult = parseFloat(document.getElementById('multiplier').value);
        let chance = parseFloat(document.getElementById('upgrade-chance').innerText);
        let roll = Math.random() * 100; // 0 to 100
        
        const marker = document.getElementById('upg-marker');
        marker.style.transition = "left 3s cubic-bezier(0.2, 0.8, 0.2, 1)";
        
        // Animate marker to the rolled position
        // Important: roll is 0-100, chance is e.g., 50. If roll is 30, it wins. 30 is left of 50.
        setTimeout(() => { marker.style.left = roll + '%'; }, 10);

        setTimeout(() => {
            if (roll <= chance) {
                // WIN (Land in green zone)
                showToast("–£–°–ü–ï–®–ù–´–ô –ê–ü–ì–†–ï–ô–î!", 'success');
                let newPrice = selectedUpgradeItem.price * mult;
                let newItem = { ...selectedUpgradeItem };
                newItem.price = newPrice;
                newItem.name = `UPGRADED: ${newItem.name}`;
                newItem.rarity = Math.min(6, newItem.rarity + 1); 
                newItem.uniqueId = Date.now();
                
                user.inventory = user.inventory.filter(i => i.uniqueId !== selectedUpgradeItem.uniqueId);
                user.inventory.unshift(newItem);
                prepUpgrade(newItem.uniqueId); // Ready next upgrade automatically
            } else {
                // LOSE
                showToast("–ù–µ—É–¥–∞—á–Ω–æ. –ü—Ä–µ–¥–º–µ—Ç —Å–≥–æ—Ä–µ–ª.", 'error');
                 user.inventory = user.inventory.filter(i => i.uniqueId !== selectedUpgradeItem.uniqueId);
                 selectedUpgradeItem = null;
                 document.getElementById('upgrade-slot').innerHTML = `<div style="color:#555;font-size:50px;">‚ùå</div><div>–°–≥–æ—Ä–µ–ª</div>`;
                 document.getElementById('upgrade-slot').style.borderColor = 'var(--danger)';
            }
            renderInventory(); saveData();
            if(selectedUpgradeItem == null) {
                 btn.disabled = true; btn.style.cursor = 'not-allowed';
            } else {
                 btn.disabled = false; btn.style.opacity = '1';
            }
        }, 3200);
    }

    // --- 7. RENDERING ---
    function renderCases() {
        const fillDiv = (id, list) => {
            const div = document.getElementById(id); div.innerHTML = '';
            list.forEach((c, idx) => {
                 // Use local PNG case images based on index, fallback to placeholder
                let imgPath = CASE_IMGS[idx] || '1.PNG'; 
                div.innerHTML += `
                    <div class="card" onclick="${id==='cases-list'?'openCase':'startBattle'}(${c.id})">
                        <img src="${imgPath}" onerror="this.src='https://via.placeholder.com/150?text=CASE+${c.id+1}'" alt="${c.name}">
                        <h3 style="font-size: 16px; margin-bottom: 5px;">${c.name}</h3>
                        <p class="item-price">$${c.price}</p>
                    </div>`;
            });
        }
        fillDiv('cases-list', CASES);
        fillDiv('battle-cases-list', CASES);
    }

    function renderInventory() {
        const div = document.getElementById('inventory-list');
        div.innerHTML = '';
        document.getElementById('inv-count').innerText = `(${user.inventory.length})`;
        if(user.inventory.length === 0) {
            div.innerHTML = '<p style="color:var(--text-sec); grid-column: 1/-1; text-align:center; padding: 50px;">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç. –û—Ç–∫—Ä–æ–π—Ç–µ –ø–∞—Ä—É –∫–µ–π—Å–æ–≤!</p>'; return;
        }
        user.inventory.forEach(item => {
            div.innerHTML += `
                <div class="card rarity-${item.rarity}">
                    ${item.imgHtml}
                    <div class="item-name" style="color:${R_COLORS[item.rarity]}">${item.name}</div>
                    <div class="item-price">$${item.price.toFixed(2)}</div>
                    <div class="action-btns">
                        <button class="btn-small btn-sell" onclick="sellItem(${item.uniqueId})">–ü—Ä–æ–¥–∞—Ç—å</button>
                        <button class="btn-small btn-upg" onclick="prepUpgrade(${item.uniqueId})">UPGRADE</button>
                    </div>
                </div>`;
        });
    }

    function sellItem(uId) {
        let item = user.inventory.find(i => i.uniqueId === uId);
        if(item) {
            user.balance += item.price;
            user.inventory = user.inventory.filter(i => i.uniqueId !== uId);
            updateBalanceUI(); renderInventory();
            showToast(`–ü—Ä–æ–¥–∞–Ω–æ: $${item.price.toFixed(2)}`, 'success');
        }
    }
    function sellAll() {
        if(user.inventory.length ===0) return;
        let total = user.inventory.reduce((sum, i) => sum + i.price, 0);
        user.balance += total; user.inventory = [];
        updateBalanceUI(); renderInventory();
        showToast(`–í—Å—ë –ø—Ä–æ–¥–∞–Ω–æ –∑–∞ $${total.toFixed(2)}`, 'success');
    }

    // --- 8. SAVE/LOAD ---
    function saveData() { localStorage.setItem('epicDropUserV2', JSON.stringify(user)); }
    function loadData() {
        let data = localStorage.getItem('epicDropUserV2');
        if(data) user = JSON.parse(data);
    }

    init();
</script>
</body>
</html>

